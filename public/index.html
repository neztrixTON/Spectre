<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Gift Marketplace MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.8.1/lottie.min.js"></script>
  <style>
    /* общий сброс */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{width:100%;height:100%;background:#141414;font-family:sans-serif;}
    #app{padding:16px;display:flex;flex-direction:column;align-items:center;}
    /* Header */
    .header{width:380px;height:70px;background:#1a1a1a;border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.5);display:flex;align-items:center;padding:0 16px;}
    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;}
    .info{margin-left:12px;color:#fff;display:flex;flex-direction:column;}
    .info .balance{font-size:18px;font-weight:bold}
    .info .user-id{font-size:12px;color:#888}
    /* Cards grid */
    #cards{width:380px;display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:24px;}
    .card{background:#1e1e1e;border-radius:8px;overflow:hidden;cursor:pointer;
      display:flex;flex-direction:column;transition:transform .1s;}
    .card:hover{transform:scale(1.02)}
    .card img{width:100%;height:130px;object-fit:cover}
    .card .title{color:#fff;padding:8px;font-weight:bold;font-size:14px;}
    .card .btn{background:#2563eb;color:#fff;padding:6px;margin:0 8px 8px;border:none;
      border-radius:4px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-size:13px;}
    .card .btn:hover{background:#1e40af}
    /* Detail page overlay */
    #detailPage{position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;
      padding:16px;overflow:auto;z-index:20;}
    #detailPage.show{display:flex;}
    #detailPage .close{align-self:flex-end;color:#fff;font-size:24px;cursor:pointer;}
    #detailPage .content{background:#222;border-radius:12px;padding:16px;
      width:100%;max-width:380px;display:flex;flex-direction:column;align-items:center;}
    /* Price popup */
    #pricePopup{position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:30;}
    #pricePopup.show{display:flex;}
    #pricePopup .box{background:#1e1e1e;padding:20px;border-radius:8px;width:300px;
      display:flex;flex-direction:column;}
    #pricePopup input{padding:10px;border-radius:4px;border:none;margin-bottom:10px;}
    #pricePopup button{padding:10px;background:#2563eb;color:#fff;border:none;
      border-radius:4px;cursor:pointer;}
  </style>
</head>
<body>
  <div id="app">
    <div class="header" id="header">
      <img id="avatar" class="avatar"/>
      <div class="info">
        <div id="balance" class="balance">0 Stars</div>
        <div id="userId" class="user-id">ID: ----</div>
      </div>
    </div>
    <!-- Input form -->
    <div class="gift-form" id="giftForm" style="width:380px;margin-top:16px;">
      <input id="giftUrls" type="text" placeholder="Введите ссылки через запятую" />
      <button id="checkMulti">Проверить подарки</button>
      <div id="errorMulti" style="color:#f87171;"></div>
    </div>
    <!-- Cards list -->
    <div id="cards"></div>
  </div>

  <!-- Detail page -->
  <div id="detailPage">
    <div class="close" id="closeDetail">&times;</div>
    <div class="content" id="detailContent"></div>
  </div>

  <!-- Price popup -->
  <div id="pricePopup">
    <div class="box">
      <input id="priceInput" placeholder="Укажите цену в $"/>
      <button id="priceSubmit">Выставить на продажу</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let chatId, uniqueId, currentGift;

    // Init
    (async()=>{
      const unsafe = tg.initDataUnsafe, init = { initData: tg.initData, initDataUnsafe:unsafe };
      chatId = unsafe.user.id;
      document.getElementById('avatar').src = unsafe.user.photo_url;
      const r = await fetch('/api/init',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(init)});
      const d = await r.json();
      uniqueId = d.unique_id;
      document.getElementById('balance').innerText = d.balance + ' Stars';
      document.getElementById('userId').innerText = 'ID: ' + uniqueId;
    })();

    // Helpers
    function normalizeUrl(u){ if(!/^https?:\/\//i.test(u)) u='https://'+u; return u; }
    function createCard(g){
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = `<img src="${g.imgUrl}"/><div class="title">${g.title} #${g.slug.split('-')[1]}</div>
                     <button class="btn">Продать</button>`;
      c.querySelector('.btn').onclick = e=>{
        e.stopPropagation();
        currentGift = g;
        document.getElementById('pricePopup').classList.add('show');
      };
      c.onclick = ()=> showDetail(g);
      return c;
    }

    // Check multiple gifts
    document.getElementById('checkMulti').onclick = async()=>{
      const inp = document.getElementById('giftUrls'), err=document.getElementById('errorMulti');
      err.innerText='';
      const urls = inp.value.split(',').map(s=>s.trim()).filter(Boolean);
      if(!urls.length){ err.innerText='Введите хотя бы одну ссылку'; return; }
      for(const raw of urls){
        try{
          const url = normalizeUrl(raw);
          const resp = await fetch('/api/check-gift',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body: JSON.stringify({url,userId:chatId})
          });
          if(!resp.ok){
            const e = await resp.json();
            err.innerText = e.error;
            continue;
          }
          const {gift} = await resp.json();
          document.getElementById('cards').appendChild(createCard(gift));
        }catch(e){
          err.innerText = e.message;
        }
      }
    };

    // Detail page
    function showDetail(g){
      const c = document.getElementById('detailContent');
      c.innerHTML = `<div style="font-size:18px;color:#fff;margin-bottom:8px;">
                       ${g.title} <span style="color:#888">#${g.slug.split('-')[1]}</span>
                     </div>
                     <div id="lottie" style="width:100%;height:200px;"></div>
                     <table style="width:100%;color:#fff;font-size:14px;text-align:left">
                       <tr><th>Model</th><td>${g.model}<mark>${g.model_rarity}%</mark></td></tr>
                       <tr><th>Backdrop</th><td>${g.backdrop}<mark>${g.backdrop_rarity}%</mark></td></tr>
                       <tr><th>Symbol</th><td>${g.symbol}<mark>${g.symbol_rarity}%</mark></td></tr>
                     </table>`;
      document.getElementById('detailPage').classList.add('show');
      // Load Lottie animation
      lottie.loadAnimation({container:document.getElementById('lottie'),
        renderer:'svg',loop:true,autoplay:true,path:g.animUrl});
    }
    document.getElementById('closeDetail').onclick = ()=> {
      document.getElementById('detailPage').classList.remove('show');
      document.getElementById('lottie').innerHTML = '';
    };

    // Price popup
    document.getElementById('priceSubmit').onclick = async()=>{
      const price = document.getElementById('priceInput').value.trim();
      if (!price) return;
      await fetch('/api/sell',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ gift:currentGift, price, sellerId:chatId })
      });
      document.getElementById('pricePopup').classList.remove('show');
      document.getElementById('priceInput').value='';
      // Optionally refresh sell-list...
    };
  </script>
</body>
</html>
